<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instaura Cloud Payroll</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAY_TN3to4yAqk7IJNqVSKFS-fSuynXwOw",
            authDomain: "teste-erhij8.firebaseapp.com",
            projectId: "teste-erhij8",
            storageBucket: "teste-erhij8.firebasestorage.app",
            messagingSenderId: "744778225564",
            appId: "1:744778225564:web:f5d6b73e501495b3dfda59"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State for App access
        window.db = db;
        window.auth = auth;
        
        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Authenticated as:", user.uid);
                window.currentUser = user;
                document.getElementById('connection-status').innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    Cloud Connected
                `;
                // Load Initial Data
                window.loadEmployees(); 
                window.loadTemplates();
                window.loadSlipHistory();
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error("Auth Error:", error);
                    document.getElementById('connection-status').innerHTML = `<span class="text-red-500">Connection Failed</span>`;
                });
            }
        });

        // --- FIRESTORE FUNCTIONS (Exposed to Window) ---
        
        // 1. Employees
        window.saveEmployee = async (empData) => {
            try {
                await addDoc(collection(db, "employees"), { ...empData, createdAt: serverTimestamp() });
                window.showToast("Employee Saved to Cloud");
                window.loadEmployees();
                window.switchView('employees');
            } catch (e) { console.error(e); window.showToast("Error Saving Employee"); }
        };

        window.loadEmployees = async () => {
            const q = query(collection(db, "employees"), orderBy("name"));
            const snapshot = await getDocs(q);
            window.employeesList = [];
            snapshot.forEach(doc => window.employeesList.push({ id: doc.id, ...doc.data() }));
            window.renderEmployeeList();
            window.renderEmployeeDropdown(); // Update builder dropdown
        };
        
        window.deleteEmployee = async (id) => {
            if(confirm('Delete this employee?')) {
                await deleteDoc(doc(db, "employees", id));
                window.loadEmployees();
                window.showToast("Employee Deleted");
            }
        };

        // 2. Templates
        window.saveTemplate = async (templateName, slipState) => {
            try {
                // Save structure (earnings/deductions labels only, no amounts)
                const template = {
                    name: templateName,
                    type: slipState.type,
                    earnings: slipState.earnings.map(e => ({ label: e.label, amount: 0 })), // Reset amounts
                    deductions: slipState.deductions.map(d => ({ label: d.label, amount: 0 })),
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, "templates"), template);
                window.showToast("Template Saved");
                window.loadTemplates();
            } catch (e) { console.error(e); window.showToast("Error Saving Template"); }
        };

        window.loadTemplates = async () => {
            const q = query(collection(db, "templates"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            window.templatesList = [];
            snapshot.forEach(doc => window.templatesList.push({ id: doc.id, ...doc.data() }));
            window.renderTemplateList();
        };
        
        window.deleteTemplate = async (id) => {
             if(confirm('Delete this template?')) {
                await deleteDoc(doc(db, "templates", id));
                window.loadTemplates();
                window.showToast("Template Deleted");
             }
        }

        // 3. Slips (History)
        window.saveSlipToHistory = async (slipData) => {
            try {
                await addDoc(collection(db, "slips"), { ...slipData, savedAt: serverTimestamp() });
                window.showToast("Slip Archived in Cloud");
                window.loadSlipHistory();
            } catch (e) { console.error(e); window.showToast("Error Saving Slip"); }
        };

        window.loadSlipHistory = async () => {
             const q = query(collection(db, "slips"), orderBy("savedAt", "desc"));
             const snapshot = await getDocs(q);
             window.slipsHistory = [];
             snapshot.forEach(doc => window.slipsHistory.push({ id: doc.id, ...doc.data() }));
             window.renderHistoryList();
        };

    </script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand-red: #dc2626;
            --brand-black: #0f172a;
            --brand-gray: #f8fafc;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--brand-gray);
            overflow: hidden; /* App-like feel */
        }

        .font-mono-num { font-family: 'JetBrains Mono', monospace; }
        .hide-scroll::-webkit-scrollbar { width: 0px; }
        
        .nav-item.active {
            background-color: var(--brand-red);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.3);
        }

        @media print {
            body * { visibility: hidden; }
            #slip-preview-container, #slip-preview-container * { visibility: visible; }
            #slip-preview-container {
                position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0;
                box-shadow: none; border: none; transform: scale(1) !important;
            }
        }

        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 0 auto;
            position: relative;
        }
        
        .input-group { transition: all 0.2s ease; }
        .input-group:focus-within { transform: translateX(4px); }
        
        /* Modal Styles */
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#dc2626',
                            black: '#000000',
                            dark: '#111827',
                            gray: '#f3f4f6'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="flex h-screen text-gray-800">

    <!-- 1. LEFT SIDEBAR -->
    <aside class="w-64 bg-black text-gray-300 flex flex-col shrink-0 z-30 transition-all duration-300" id="sidebar">
        <!-- Brand -->
        <div class="h-16 flex items-center px-6 border-b border-gray-800 bg-gray-900">
            <div class="w-8 h-8 bg-brand-red rounded flex items-center justify-center mr-3">
                <span class="text-white font-bold text-lg">I</span>
            </div>
            <div>
                <h1 class="text-white font-bold tracking-wider text-lg">INSTAURA</h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest">CLOUD HR</p>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <p class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Workspace</p>
            
            <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-gray-800 hover:text-white transition-colors active">
                <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard
            </button>
            
            <button onclick="switchView('builder')" id="nav-builder" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-gray-800 hover:text-white transition-colors">
                <i data-lucide="file-plus-2" class="w-4 h-4"></i> Create New Slip
            </button>
            
            <button onclick="switchView('history')" id="nav-history" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-gray-800 hover:text-white transition-colors">
                <i data-lucide="folder-clock" class="w-4 h-4"></i> Slip History
            </button>

            <p class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 mt-6">Database</p>
            
            <button onclick="switchView('employees')" id="nav-employees" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-gray-800 hover:text-white transition-colors">
                <i data-lucide="users" class="w-4 h-4"></i> Staff / Employees
            </button>
            
            <button onclick="switchView('templates')" id="nav-templates" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-gray-800 hover:text-white transition-colors">
                <i data-lucide="layout-template" class="w-4 h-4"></i> Templates
            </button>
        </nav>

        <!-- User Profile -->
        <div class="p-4 border-t border-gray-800 bg-gray-900/50">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center">
                    <i data-lucide="user" class="w-4 h-4 text-gray-400"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-white">HR Admin</p>
                    <p class="text-xs text-gray-500">Authenticated</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- 2. MAIN CONTENT AREA -->
    <main class="flex-1 flex flex-col bg-gray-50 overflow-hidden relative">
        
        <!-- Top Header -->
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0 z-20">
            <h2 id="page-title" class="text-xl font-bold text-gray-800">Dashboard</h2>
            <div class="flex items-center gap-4">
                 <!-- Firebase Connection Status -->
                <div id="connection-status" class="flex items-center gap-2 text-sm text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full transition-all">
                    <span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span>
                    Connecting to Cloud...
                </div>
            </div>
        </header>

        <!-- VIEWS CONTAINER -->
        <div class="flex-1 overflow-hidden relative">
            
            <!-- VIEW: DASHBOARD (Landing) -->
            <div id="view-dashboard" class="absolute inset-0 p-8 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow cursor-pointer group" onclick="switchView('builder')">
                        <div class="w-12 h-12 bg-red-50 rounded-lg flex items-center justify-center mb-4 group-hover:bg-brand-red group-hover:text-white transition-colors text-brand-red">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Generate Slip</h3>
                        <p class="text-sm text-gray-500 mt-1">Create a new payroll document using employee data.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow cursor-pointer group" onclick="switchView('employees')">
                        <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center mb-4 group-hover:bg-blue-600 group-hover:text-white transition-colors text-blue-600">
                            <i data-lucide="users" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Manage Staff</h3>
                        <p class="text-sm text-gray-500 mt-1">Add or edit employee profiles and base salaries.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow cursor-pointer group" onclick="switchView('history')">
                        <div class="w-12 h-12 bg-black rounded-lg flex items-center justify-center mb-4 group-hover:bg-gray-800 transition-colors text-white">
                            <i data-lucide="history" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Slip History</h3>
                        <p class="text-sm text-gray-500 mt-1">View and reprint previously generated slips.</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="font-bold text-gray-800 mb-4">Quick Stats</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-brand-red" id="stat-emp-count">--</p>
                            <p class="text-xs text-gray-500 uppercase tracking-wider">Employees</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-800" id="stat-slip-count">--</p>
                            <p class="text-xs text-gray-500 uppercase tracking-wider">Slips Generated</p>
                        </div>
                         <div class="p-4 bg-gray-50 rounded-lg">
                            <p class="text-2xl font-bold text-gray-800" id="stat-template-count">--</p>
                            <p class="text-xs text-gray-500 uppercase tracking-wider">Templates</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: EMPLOYEES (CRUD) -->
            <div id="view-employees" class="absolute inset-0 p-8 overflow-y-auto hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Staff Directory</h3>
                    <button onclick="openEmployeeModal()" class="bg-brand-black text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-800 flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> Add Employee
                    </button>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3">Name</th>
                                <th class="px-6 py-3">ID</th>
                                <th class="px-6 py-3">Designation</th>
                                <th class="px-6 py-3">Department</th>
                                <th class="px-6 py-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employee-table-body">
                            <!-- Dynamic Rows -->
                            <tr><td colspan="5" class="px-6 py-8 text-center">Loading staff from cloud...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: BUILDER (Split Screen) -->
            <div id="view-builder" class="absolute inset-0 flex hidden">
                
                <!-- Builder Sidebar -->
                <div class="w-96 bg-white border-r border-gray-200 flex flex-col z-10 shadow-xl overflow-hidden">
                    <!-- Toolbar -->
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                        <button onclick="switchView('dashboard')" class="p-1 hover:bg-gray-200 rounded"><i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                        <span class="font-bold text-sm text-gray-700 uppercase" id="builder-type-label">BUILDER</span>
                        <div class="flex gap-1">
                            <button onclick="resetBuilder()" class="p-1.5 text-gray-500 hover:text-red-600" title="Reset"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                            <button onclick="openTemplateSaveModal()" class="p-1.5 text-gray-500 hover:text-blue-600" title="Save as Template"><i data-lucide="layout-template" class="w-4 h-4"></i></button>
                            <button onclick="archiveSlip()" class="p-1.5 text-gray-500 hover:text-green-600" title="Archive to History"><i data-lucide="save" class="w-4 h-4"></i></button>
                        </div>
                    </div>

                    <!-- Scrollable Form Area -->
                    <div class="flex-1 overflow-y-auto p-5 space-y-6">
                        
                        <!-- Quick Loaders -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Load Employee</label>
                                <select id="builder-emp-select" onchange="loadEmployeeToBuilder(this.value)" class="w-full mt-1 p-2 bg-gray-50 border border-gray-200 rounded text-sm focus:border-brand-red outline-none">
                                    <option value="">Select Staff...</option>
                                    <!-- Options filled by JS -->
                                </select>
                            </div>
                             <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Load Template</label>
                                <select id="builder-template-select" onchange="loadTemplateToBuilder(this.value)" class="w-full mt-1 p-2 bg-gray-50 border border-gray-200 rounded text-sm focus:border-brand-red outline-none">
                                    <option value="">Select Template...</option>
                                    <!-- Options filled by JS -->
                                </select>
                            </div>
                        </div>

                        <hr class="border-gray-100">

                        <!-- Section: Basic Info -->
                        <div class="space-y-4">
                            <h4 class="text-xs font-bold text-gray-900 uppercase">Slip Details</h4>
                             <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="inp-period" placeholder="Pay Period (e.g. Dec 2025)" class="col-span-2 w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded text-sm focus:border-brand-red focus:outline-none" oninput="updateState('period', this.value)">
                                <input type="text" id="inp-name" placeholder="Employee Name" class="col-span-2 w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded text-sm focus:border-brand-red focus:outline-none" oninput="updateState('empName', this.value)">
                                <input type="text" id="inp-id" placeholder="ID (e.g. EMP-001)" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded text-sm focus:border-brand-red focus:outline-none" oninput="updateState('empId', this.value)">
                                <input type="text" id="inp-desig" placeholder="Designation" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded text-sm focus:border-brand-red focus:outline-none" oninput="updateState('designation', this.value)">
                                <input type="text" id="inp-dept" placeholder="Department" class="col-span-2 w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded text-sm focus:border-brand-red focus:outline-none" oninput="updateState('department', this.value)">
                            </div>
                        </div>

                        <!-- Section: Earnings -->
                        <div class="space-y-3">
                            <div class="flex items-center justify-between border-b border-gray-100 pb-2">
                                <h4 class="text-xs font-bold text-green-700 uppercase flex items-center gap-1"><i data-lucide="plus-circle" class="w-3 h-3"></i> Earnings</h4>
                                <button onclick="addEarningField()" class="text-[10px] bg-green-50 text-green-700 px-2 py-1 rounded hover:bg-green-100">+ Add</button>
                            </div>
                            <div id="earnings-container" class="space-y-2">
                                <!-- Dynamic Fields Injected Here -->
                            </div>
                        </div>

                        <!-- Section: Deductions -->
                        <div class="space-y-3">
                            <div class="flex items-center justify-between border-b border-gray-100 pb-2">
                                <h4 class="text-xs font-bold text-brand-red uppercase flex items-center gap-1"><i data-lucide="minus-circle" class="w-3 h-3"></i> Deductions</h4>
                                <button onclick="addDeductionField()" class="text-[10px] bg-red-50 text-brand-red px-2 py-1 rounded hover:bg-red-100">+ Add</button>
                            </div>
                            <div id="deductions-container" class="space-y-2">
                                <!-- Dynamic Fields Injected Here -->
                            </div>
                        </div>
                        
                         <!-- Section: Approvals -->
                        <div class="space-y-3 pt-4 border-t border-gray-200">
                             <h4 class="text-xs font-bold text-gray-500 uppercase">Authorization</h4>
                             <div class="grid grid-cols-1 gap-3">
                                <input type="text" id="inp-prepared" placeholder="Prepared By" value="HR Admin" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded text-sm" oninput="updateState('preparedBy', this.value)">
                                <input type="text" id="inp-approved" placeholder="Approved By" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded text-sm" oninput="updateState('approvedBy', this.value)">
                             </div>
                        </div>

                        <div class="h-20"></div>
                    </div>
                </div>

                <!-- Preview Area -->
                <div class="flex-1 bg-gray-200/50 overflow-auto p-8 flex justify-center items-start">
                    <!-- Toolbar Floating -->
                    <div class="fixed top-20 right-8 flex flex-col gap-2 z-20">
                         <button onclick="exportPNG()" class="bg-white p-2 rounded-lg shadow-lg hover:bg-gray-50 border border-gray-200 text-gray-700" title="Download Image"><i data-lucide="image" class="w-5 h-5"></i></button>
                        <button onclick="exportPDF()" class="bg-brand-black p-2 rounded-lg shadow-lg hover:bg-gray-800 text-white" title="Download PDF"><i data-lucide="file-down" class="w-5 h-5"></i></button>
                        <button onclick="window.print()" class="bg-brand-red p-2 rounded-lg shadow-lg hover:bg-red-700 text-white" title="Print"><i data-lucide="printer" class="w-5 h-5"></i></button>
                    </div>

                    <!-- THE SLIP (A4) -->
                    <div id="slip-preview-container" class="a4-paper p-12 text-gray-900 flex flex-col">
                        <!-- Header -->
                        <div class="flex justify-between items-start mb-8 border-b-4 border-black pb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-black text-white flex items-center justify-center font-bold text-3xl tracking-tighter rounded-sm">I</div>
                                <div>
                                    <h1 class="text-4xl font-extrabold tracking-tight text-black uppercase">INSTAURA</h1>
                                    <p class="text-xs text-gray-500 tracking-widest uppercase mt-1">Enterprise Solutions Pvt Ltd</p>
                                    <p class="text-xs text-gray-400 mt-0.5">DLF Cyber City, Gurugram, India</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <h2 id="prev-slip-title" class="text-2xl font-bold text-gray-400 uppercase tracking-widest">SALARY SLIP</h2>
                                <p id="prev-period" class="text-lg font-bold text-brand-red mt-1">December 2025</p>
                                <p class="text-xs text-gray-400 mt-1">Ref: <span id="prev-ref">SLIP-GEN-001</span></p>
                            </div>
                        </div>

                        <!-- Employee Grid -->
                        <div class="grid grid-cols-2 gap-x-12 gap-y-4 mb-8 text-sm border-b border-gray-200 pb-8">
                            <div><p class="text-[10px] text-gray-400 uppercase font-semibold">Employee Name</p><p id="prev-name" class="text-lg font-bold text-black border-l-2 border-brand-red pl-2">-</p></div>
                            <div><p class="text-[10px] text-gray-400 uppercase font-semibold">Employee ID</p><p id="prev-id" class="text-base font-medium text-gray-800 border-l-2 border-gray-300 pl-2">-</p></div>
                            <div><p class="text-[10px] text-gray-400 uppercase font-semibold">Designation</p><p id="prev-desig" class="text-base font-medium text-gray-800 border-l-2 border-gray-300 pl-2">-</p></div>
                            <div><p class="text-[10px] text-gray-400 uppercase font-semibold">Department</p><p id="prev-dept" class="text-base font-medium text-gray-800 border-l-2 border-gray-300 pl-2">-</p></div>
                        </div>

                        <!-- Calculation Table -->
                        <div class="flex-1">
                            <div class="border border-gray-300">
                                <div class="grid grid-cols-2 bg-gray-100 border-b border-black">
                                    <div class="grid grid-cols-2"><div class="p-2 font-bold text-xs uppercase text-gray-600 border-r border-gray-300">Earnings</div><div class="p-2 font-bold text-xs uppercase text-right text-gray-600 border-r border-gray-300">Amount (₹)</div></div>
                                    <div class="grid grid-cols-2"><div class="p-2 font-bold text-xs uppercase text-gray-600 border-r border-gray-300">Deductions</div><div class="p-2 font-bold text-xs uppercase text-right text-gray-600">Amount (₹)</div></div>
                                </div>
                                <div id="slip-table-body"><!-- Rows injected by JS --></div>
                                <div class="grid grid-cols-2 bg-gray-50 border-t-2 border-black">
                                    <div class="grid grid-cols-2"><div class="p-3 font-bold text-xs uppercase text-black border-r border-gray-300 pt-4">Total Earnings</div><div id="prev-total-earn" class="p-3 font-mono-num font-bold text-sm text-right text-black border-r border-gray-300 pt-4">0.00</div></div>
                                    <div class="grid grid-cols-2"><div class="p-3 font-bold text-xs uppercase text-black border-r border-gray-300 pt-4">Total Deductions</div><div id="prev-total-ded" class="p-3 font-mono-num font-bold text-sm text-right text-brand-red pt-4">0.00</div></div>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-between items-center bg-black text-white p-4 shadow-lg border-l-8 border-brand-red">
                                <div><p class="text-[10px] uppercase tracking-widest opacity-70">Net Pay</p><p id="prev-words" class="text-xs italic text-gray-300 mt-1">Zero Only</p></div>
                                <div class="text-right"><p id="prev-net" class="text-3xl font-mono-num font-bold">₹0.00</p></div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="mt-12 pt-12 border-t border-gray-200">
                             <div class="grid grid-cols-2 gap-20 mb-8">
                                <div><p id="prev-prepared" class="font-bold text-sm text-gray-800">HR Admin</p><p class="text-[10px] text-gray-400 uppercase mt-1">Prepared By</p></div>
                                <div class="text-right"><div class="inline-block text-center"><div class="h-10 border-b border-black w-40 mb-1"></div><p class="text-[10px] text-gray-800 font-bold uppercase tracking-wider">Authorized Signature</p><p id="prev-approved" class="text-[9px] text-gray-500 mt-0.5">Approved By: -</p></div></div>
                             </div>
                             <div class="text-center text-[10px] text-gray-400 uppercase tracking-widest flex items-center justify-center gap-2">
                                 <span class="w-1.5 h-1.5 bg-brand-red rounded-full"></span> This is a system-generated payroll document by Instaura. <span class="w-1.5 h-1.5 bg-brand-red rounded-full"></span>
                             </div>
                        </div>
                    </div>
                    <div class="h-20"></div>
                </div>
            </div>

            <!-- VIEW: HISTORY -->
            <div id="view-history" class="absolute inset-0 p-8 overflow-y-auto hidden">
                <h3 class="text-lg font-bold text-gray-800 mb-6">Generated Slips Archive</h3>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                            <tr><th class="px-6 py-3">Date</th><th class="px-6 py-3">Employee</th><th class="px-6 py-3">Type</th><th class="px-6 py-3">Net Pay</th><th class="px-6 py-3 text-right">Actions</th></tr>
                        </thead>
                        <tbody id="history-table-body">
                            <tr><td colspan="5" class="px-6 py-8 text-center">Loading history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: TEMPLATES -->
             <div id="view-templates" class="absolute inset-0 p-8 overflow-y-auto hidden">
                <h3 class="text-lg font-bold text-gray-800 mb-6">Saved Templates</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="templates-grid">
                    <!-- Dynamic -->
                </div>
            </div>

        </div>
    </main>

    <!-- MODAL: ADD EMPLOYEE -->
    <div id="modal-employee" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-96 p-6 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Add New Employee</h3>
            <div class="space-y-3">
                <input type="text" id="m-emp-name" placeholder="Full Name" class="w-full px-3 py-2 border rounded">
                <input type="text" id="m-emp-id" placeholder="Employee ID (e.g. EMP-005)" class="w-full px-3 py-2 border rounded">
                <input type="text" id="m-emp-desig" placeholder="Designation" class="w-full px-3 py-2 border rounded">
                <input type="text" id="m-emp-dept" placeholder="Department" class="w-full px-3 py-2 border rounded">
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeModal('modal-employee')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="submitEmployee()" class="px-4 py-2 bg-brand-black text-white rounded hover:bg-gray-800">Save Staff</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-brand-black text-white px-6 py-3 rounded-lg shadow-2xl transform translate-y-24 opacity-0 transition-all duration-300 z-50 flex items-center gap-3 border border-gray-800">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
        <span id="toast-msg" class="text-sm font-medium">Notification</span>
    </div>

    <!-- MAIN LOGIC -->
    <script>
        // --- LOCAL STATE ---
        const defaultState = {
            view: 'dashboard',
            type: 'Salary Slip',
            empName: '', empId: '', designation: '', department: '', period: '', preparedBy: 'HR Admin', approvedBy: '',
            earnings: [{ id: 'e1', label: 'Basic Salary', amount: 0 }, { id: 'e2', label: 'HRA', amount: 0 }],
            deductions: [{ id: 'd1', label: 'Provident Fund', amount: 0 }]
        };
        let state = JSON.parse(JSON.stringify(defaultState));

        // --- NAVIGATION & UI ---
        window.switchView = (viewName) => {
            ['dashboard', 'builder', 'employees', 'history', 'templates'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById(`nav-${viewName}`)) document.getElementById(`nav-${viewName}`).classList.add('active');
            
            // Refresh stats if dashboard
            if(viewName === 'dashboard') updateStats();
            
            lucide.createIcons();
        };
        
        // --- BUILDER LOGIC ---
        window.updateState = (key, value) => { state[key] = value; renderPreview(); };
        window.resetBuilder = () => { state = JSON.parse(JSON.stringify(defaultState)); renderBuilderInputs(); renderPreview(); };
        
        window.addEarningField = () => { state.earnings.push({ id: 'e'+Date.now(), label: 'Allowance', amount: 0 }); renderBuilderInputs(); renderPreview(); };
        window.updateEarning = (id, field, value) => { const it = state.earnings.find(e=>e.id===id); if(it) { it[field] = field==='amount'?parseFloat(value)||0:value; renderPreview(); }};
        window.removeEarning = (id) => { state.earnings = state.earnings.filter(e=>e.id!==id); renderBuilderInputs(); renderPreview(); };

        window.addDeductionField = () => { state.deductions.push({ id: 'd'+Date.now(), label: 'Deduction', amount: 0 }); renderBuilderInputs(); renderPreview(); };
        window.updateDeduction = (id, field, value) => { const it = state.deductions.find(d=>d.id===id); if(it) { it[field] = field==='amount'?parseFloat(value)||0:value; renderPreview(); }};
        window.removeDeduction = (id) => { state.deductions = state.deductions.filter(d=>d.id!==id); renderBuilderInputs(); renderPreview(); };

        window.renderBuilderInputs = () => {
            document.getElementById('inp-name').value = state.empName;
            document.getElementById('inp-id').value = state.empId;
            document.getElementById('inp-desig').value = state.designation;
            document.getElementById('inp-dept').value = state.department;
            
            document.getElementById('earnings-container').innerHTML = state.earnings.map(item => `
                <div class="flex items-center gap-2 input-group"><input type="text" value="${item.label}" class="w-1/2 px-2 py-1.5 bg-white border border-gray-200 rounded text-xs font-medium focus:border-green-500 outline-none" oninput="updateEarning('${item.id}', 'label', this.value)"><input type="number" value="${item.amount}" class="w-1/3 px-2 py-1.5 bg-white border border-gray-200 rounded text-xs text-right font-mono-num focus:border-green-500 outline-none" oninput="updateEarning('${item.id}', 'amount', this.value)"><button onclick="removeEarning('${item.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>
            `).join('');
            document.getElementById('deductions-container').innerHTML = state.deductions.map(item => `
                <div class="flex items-center gap-2 input-group"><input type="text" value="${item.label}" class="w-1/2 px-2 py-1.5 bg-white border border-gray-200 rounded text-xs font-medium focus:border-red-500 outline-none" oninput="updateDeduction('${item.id}', 'label', this.value)"><input type="number" value="${item.amount}" class="w-1/3 px-2 py-1.5 bg-white border border-gray-200 rounded text-xs text-right font-mono-num focus:border-red-500 outline-none" oninput="updateDeduction('${item.id}', 'amount', this.value)"><button onclick="removeDeduction('${item.id}')" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>
            `).join('');
            lucide.createIcons();
        };

        window.renderPreview = () => {
            document.getElementById('prev-slip-title').innerText = state.type || 'SALARY SLIP';
            document.getElementById('prev-name').innerText = state.empName || '-';
            document.getElementById('prev-id').innerText = state.empId || '-';
            document.getElementById('prev-desig').innerText = state.designation || '-';
            document.getElementById('prev-dept').innerText = state.department || '-';
            document.getElementById('prev-period').innerText = state.period || '-';
            document.getElementById('prev-prepared').innerText = state.preparedBy || 'HR Admin';
            document.getElementById('prev-approved').innerText = `Approved By: ${state.approvedBy || '-'}`;
            document.getElementById('prev-ref').innerText = state.empId ? `REF-${state.empId}-${new Date().getMonth()+1}` : 'REF-GEN-001';

            let totalEarn = 0, totalDed = 0;
            const maxRows = Math.max(state.earnings.length, state.deductions.length);
            let html = '';
            for(let i=0; i<maxRows; i++){
                const e = state.earnings[i], d = state.deductions[i];
                if(e) totalEarn += e.amount; if(d) totalDed += d.amount;
                html += `<div class="grid grid-cols-2 border-b border-gray-200 hover:bg-gray-50 text-sm"><div class="grid grid-cols-2"><div class="p-2 text-gray-700 border-r border-gray-200 pl-4">${e?e.label:''}</div><div class="p-2 text-right font-mono-num text-gray-900 border-r border-gray-200">${e?e.amount.toFixed(2):''}</div></div><div class="grid grid-cols-2"><div class="p-2 text-gray-700 border-r border-gray-200 pl-4">${d?d.label:''}</div><div class="p-2 text-right font-mono-num text-red-600">${d?d.amount.toFixed(2):''}</div></div></div>`;
            }
            if(maxRows===0) html = `<div class="p-4 text-center text-xs text-gray-400 italic">No items</div>`;
            document.getElementById('slip-table-body').innerHTML = html;
            document.getElementById('prev-total-earn').innerText = totalEarn.toFixed(2);
            document.getElementById('prev-total-ded').innerText = totalDed.toFixed(2);
            const net = totalEarn - totalDed;
            document.getElementById('prev-net').innerText = '₹' + net.toLocaleString('en-IN', {minimumFractionDigits: 2});
            document.getElementById('prev-words').innerText = net>0 ? `(Net Amount in Words Generated)` : 'Zero Only';
        };

        // --- EMPLOYEE MODULE ---
        window.openEmployeeModal = () => document.getElementById('modal-employee').classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.submitEmployee = () => {
            const data = {
                name: document.getElementById('m-emp-name').value,
                empId: document.getElementById('m-emp-id').value,
                designation: document.getElementById('m-emp-desig').value,
                department: document.getElementById('m-emp-dept').value
            };
            if(!data.name || !data.empId) return alert('Name and ID required');
            window.saveEmployee(data);
            closeModal('modal-employee');
            document.getElementById('m-emp-name').value = '';
        };

        window.renderEmployeeList = () => {
            const list = window.employeesList || [];
            const html = list.length ? list.map(emp => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-900">${emp.name}</td>
                    <td class="px-6 py-4">${emp.empId}</td>
                    <td class="px-6 py-4">${emp.designation}</td>
                    <td class="px-6 py-4">${emp.department}</td>
                    <td class="px-6 py-4 text-right"><button onclick="deleteEmployee('${emp.id}')" class="text-red-600 hover:underline">Delete</button></td>
                </tr>
            `).join('') : `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400">No employees found. Add one!</td></tr>`;
            document.getElementById('employee-table-body').innerHTML = html;
        };

        window.renderEmployeeDropdown = () => {
             const list = window.employeesList || [];
             const opts = `<option value="">Select Staff...</option>` + list.map(e => `<option value="${e.id}">${e.name} (${e.empId})</option>`).join('');
             document.getElementById('builder-emp-select').innerHTML = opts;
        };

        window.loadEmployeeToBuilder = (id) => {
            if(!id) return;
            const emp = window.employeesList.find(e => e.id === id);
            if(emp) {
                state.empName = emp.name; state.empId = emp.empId;
                state.designation = emp.designation; state.department = emp.department;
                renderBuilderInputs(); renderPreview();
                window.showToast("Staff Details Loaded");
            }
        };

        // --- TEMPLATE MODULE ---
        window.openTemplateSaveModal = () => {
            const name = prompt("Enter Template Name (e.g., 'Intern Stipend'):");
            if(name) window.saveTemplate(name, state);
        };
        
        window.renderTemplateList = () => {
            const list = window.templatesList || [];
            const html = list.map(t => `
                <div class="bg-white p-4 rounded-lg border border-gray-200 flex justify-between items-center">
                    <div><h4 class="font-bold text-gray-800">${t.name}</h4><p class="text-xs text-gray-500">${t.type}</p></div>
                    <button onclick="deleteTemplate('${t.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            document.getElementById('templates-grid').innerHTML = html || '<p class="text-gray-400">No templates saved.</p>';
            
            // Dropdown
            const opts = `<option value="">Select Template...</option>` + list.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            document.getElementById('builder-template-select').innerHTML = opts;
        };

        window.loadTemplateToBuilder = (id) => {
            if(!id) return;
            const t = window.templatesList.find(x => x.id === id);
            if(t) {
                state.type = t.type;
                state.earnings = t.earnings.map(e => ({...e, id: 'e'+Math.random()})); // New IDs
                state.deductions = t.deductions.map(d => ({...d, id: 'd'+Math.random()}));
                renderBuilderInputs(); renderPreview();
                window.showToast("Template Loaded");
            }
        };

        // --- HISTORY MODULE ---
        window.archiveSlip = () => {
            if(!state.empName) return alert('Cannot archive empty slip');
            const slipData = { ...state, netPay: document.getElementById('prev-net').innerText };
            window.saveSlipToHistory(slipData);
        };

        window.renderHistoryList = () => {
             const list = window.slipsHistory || [];
             const html = list.map(s => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${s.savedAt ? new Date(s.savedAt.seconds*1000).toLocaleDateString() : 'Just now'}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">${s.empName}</td>
                    <td class="px-6 py-4">${s.type}</td>
                    <td class="px-6 py-4 font-mono-num font-bold">${s.netPay}</td>
                    <td class="px-6 py-4 text-right"><span class="text-green-600 text-xs bg-green-50 px-2 py-1 rounded">Archived</span></td>
                </tr>
            `).join('');
            document.getElementById('history-table-body').innerHTML = html || `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400">No slips generated yet.</td></tr>`;
        };

        // --- UTILS ---
        window.updateStats = () => {
            document.getElementById('stat-emp-count').innerText = (window.employeesList||[]).length;
            document.getElementById('stat-slip-count').innerText = (window.slipsHistory||[]).length;
            document.getElementById('stat-template-count').innerText = (window.templatesList||[]).length;
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(()=>t.classList.add('translate-y-24', 'opacity-0'), 3000);
        };

        window.exportPDF = () => {
            const element = document.getElementById('slip-preview-container');
            const opt = { margin: 0, filename: `Instaura_${state.empId}.pdf`, image: { type: 'jpeg', quality: 1 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().set(opt).from(element).save();
        };
        
        // Initial Render
        renderBuilderInputs();
        renderPreview();
        lucide.createIcons();
    </script>
</body>
</html>
